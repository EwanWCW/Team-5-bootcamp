---
- name: Configure Kubernetes Cluster
  hosts: all
  become: yes
  vars:
    kubernetes_version: "1.31.0"  # Set the desired Kubernetes version
    cni_plugin: "flannel"         # Specify CNI (Flannel or Calico)

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install dependencies for Kubernetes
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Add Docker repository GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present

    - name: Install Docker CE
      apt:
        name: docker-ce
        state: present

    - name: Ensure Docker service is enabled and started
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Add Kubernetes apt repository GPG key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present

    - name: Add Kubernetes repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/"
        state: present

    - name: Install Kubernetes components
      apt:
        name:
          - kubelet={{ kubernetes_version }}-00
          - kubeadm={{ kubernetes_version }}-00
          - kubectl={{ kubernetes_version }}-00
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages from being updated
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        mark: hold

    - name: Enable kubelet service
      systemd:
        name: kubelet
        enabled: yes
        state: started

- name: Initialize Kubernetes Master (Control Plane)
  hosts: master
  become: yes
  tasks:
    - name: Initialize Kubernetes Cluster
      command: kubeadm init --pod-network-cidr=10.244.0.0/16
      register: kubeadm_output
      ignore_errors: yes

    - name: Save kubeadm join command to file
      copy:
        content: "{{ kubeadm_output.stdout }}"
        dest: /tmp/kubeadm_init_output.txt

    - name: Create .kube directory
      file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        mode: 0755

    - name: Copy admin.conf to .kube/config
      command: |
        mkdir -p $HOME/.kube
        sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
        sudo chown $(id -u):$(id -g) $HOME/.kube/config
      become: no

    - name: Install Flannel CNI plugin
      command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

- name: Join Kubernetes Workers
  hosts: worker
  become: yes
  tasks:
    - name: Fetch kubeadm join command from master node
      command: cat /tmp/kubeadm_init_output.txt
      register: join_command

    - name: Join the worker node to the Kubernetes cluster
      command: "{{ join_command.stdout }}"
      ignore_errors: yes

